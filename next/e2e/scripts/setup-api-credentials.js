#!/usr/bin/env node

/**
 * Setup WooCommerce API Credentials for E2E Testing
 *
 * This script generates WooCommerce REST API credentials using wp-env
 * and saves them to .env.test for use by E2E tests.
 *
 * Usage: node e2e/scripts/setup-api-credentials.js
 */

const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");

const ENV_FILE = path.join(__dirname, "../../.env.test");

/**
 * Execute a wp-env CLI command and return the output
 */
function wpEnvRun(command, options = {}) {
  const fullCommand = `npx wp-env run cli ${command}`;
  console.log(`Running: ${fullCommand}`);
  try {
    const output = execSync(fullCommand, {
      cwd: path.join(__dirname, "../.."),
      encoding: "utf-8",
      stdio: options.silent ? ["pipe", "pipe", "pipe"] : ["pipe", "pipe", "inherit"],
    });
    return output.trim();
  } catch (error) {
    if (options.ignoreError) {
      return error.stdout ? error.stdout.trim() : "";
    }
    throw error;
  }
}

/**
 * Check if wp-env is running
 */
function isWpEnvRunning() {
  try {
    const output = execSync("npx wp-env run cli wp option get siteurl", {
      cwd: path.join(__dirname, "../.."),
      encoding: "utf-8",
      stdio: ["pipe", "pipe", "pipe"],
    });
    return output.includes("http");
  } catch {
    return false;
  }
}

/**
 * Get the WordPress port from wp-env
 */
function getWpEnvPort() {
  try {
    const output = execSync("npx wp-env run cli wp option get siteurl", {
      cwd: path.join(__dirname, "../.."),
      encoding: "utf-8",
      stdio: ["pipe", "pipe", "pipe"],
    });
    const match = output.match(/:(\d+)/);
    return match ? match[1] : "8888";
  } catch {
    return "8888";
  }
}

/**
 * Generate WooCommerce API credentials using WP-CLI
 *
 * WooCommerce stores API keys in the woocommerce_api_keys table.
 * We use a custom WP-CLI command to generate credentials.
 */
function generateWooCommerceCredentials() {
  console.log("\nGenerating WooCommerce API credentials...");

  // First, ensure WooCommerce is active
  try {
    wpEnvRun("wp plugin activate woocommerce", { silent: true, ignoreError: true });
  } catch {
    // Plugin might already be active
  }

  // Generate a unique description for this key
  const keyDescription = `E2E Tests - ${new Date().toISOString().split("T")[0]}`;

  // Use WP-CLI to execute PHP that generates API credentials
  // WooCommerce provides the wc_create_api_key function for this
  const phpScript = `
    // Ensure WooCommerce is loaded
    if (!function_exists('wc_create_api_key')) {
      require_once WP_PLUGIN_DIR . '/woocommerce/includes/wc-api-functions.php';
    }

    // Get or create admin user
    $admin_user = get_user_by('login', 'admin');
    if (!$admin_user) {
      $admin_id = wp_create_user('admin', 'password', 'admin@example.com');
      $admin_user = get_user_by('ID', $admin_id);
      $admin_user->set_role('administrator');
    }

    // Delete any existing E2E test keys
    global $wpdb;
    $wpdb->delete(
      $wpdb->prefix . 'woocommerce_api_keys',
      array('description' => '${keyDescription}'),
      array('%s')
    );

    // Generate new API key
    $consumer_key = 'ck_' . wc_rand_hash();
    $consumer_secret = 'cs_' . wc_rand_hash();

    $data = array(
      'user_id' => $admin_user->ID,
      'description' => '${keyDescription}',
      'permissions' => 'read_write',
      'consumer_key' => wc_api_hash($consumer_key),
      'consumer_secret' => $consumer_secret,
      'truncated_key' => substr($consumer_key, -7),
    );

    $wpdb->insert(
      $wpdb->prefix . 'woocommerce_api_keys',
      $data,
      array('%d', '%s', '%s', '%s', '%s', '%s')
    );

    echo json_encode(array(
      'consumer_key' => $consumer_key,
      'consumer_secret' => $consumer_secret
    ));
  `.replace(/\n/g, " ").replace(/'/g, "'\\''");

  const output = wpEnvRun(`wp eval '${phpScript}'`, { silent: true });

  // Parse the JSON output (it's at the end after any wp-env prefixes)
  const jsonMatch = output.match(/\{[^}]+\}/);
  if (!jsonMatch) {
    throw new Error(`Failed to parse credentials from output: ${output}`);
  }

  return JSON.parse(jsonMatch[0]);
}

/**
 * Save credentials to .env.test file
 */
function saveCredentials(credentials, wpPort) {
  console.log("\nSaving credentials to .env.test...");

  const envContent = `# WooCommerce API Credentials for E2E Testing
# Generated by e2e/scripts/setup-api-credentials.js
# DO NOT COMMIT THIS FILE

WC_CONSUMER_KEY=${credentials.consumer_key}
WC_CONSUMER_SECRET=${credentials.consumer_secret}
WP_PORT=${wpPort}
WP_BASE_URL=http://localhost:${wpPort}
`;

  fs.writeFileSync(ENV_FILE, envContent, "utf-8");
  console.log(`Credentials saved to ${ENV_FILE}`);
}

/**
 * Check if credentials already exist and are valid
 */
function existingCredentialsValid() {
  if (!fs.existsSync(ENV_FILE)) {
    return false;
  }

  const content = fs.readFileSync(ENV_FILE, "utf-8");
  const hasKey = content.includes("WC_CONSUMER_KEY=ck_");
  const hasSecret = content.includes("WC_CONSUMER_SECRET=cs_");

  return hasKey && hasSecret;
}

/**
 * Main function
 */
async function main() {
  console.log("=== WooCommerce API Credentials Setup ===\n");

  // Check if wp-env is running
  if (!isWpEnvRunning()) {
    console.error("Error: wp-env is not running.");
    console.error("Please start it with: npm run wp-env:start");
    process.exit(1);
  }

  // Check for existing credentials
  if (existingCredentialsValid()) {
    console.log("Existing credentials found in .env.test");

    // Check if --force flag is passed
    if (!process.argv.includes("--force")) {
      console.log("Use --force to regenerate credentials.");
      process.exit(0);
    }
    console.log("Regenerating credentials (--force flag detected)...");
  }

  // Get WordPress port
  const wpPort = getWpEnvPort();
  console.log(`WordPress running on port: ${wpPort}`);

  // Generate credentials
  const credentials = generateWooCommerceCredentials();
  console.log("\nCredentials generated successfully:");
  console.log(`  Consumer Key: ${credentials.consumer_key.substring(0, 10)}...`);
  console.log(`  Consumer Secret: ${credentials.consumer_secret.substring(0, 10)}...`);

  // Save to .env.test
  saveCredentials(credentials, wpPort);

  console.log("\n=== Setup Complete ===");
  console.log("\nYou can now run E2E tests with: npm run test:e2e");
}

main().catch((error) => {
  console.error("\nSetup failed:", error.message);
  process.exit(1);
});
